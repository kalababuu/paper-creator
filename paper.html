<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Workspace - Copy creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .upload-zone { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .upload-zone:hover {
            border-color: #6366f1;
            background-color: #f8fafc;
            transform: translateY(-2px);

        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .document-font { font-family: 'Merriweather', serif; }
        
        #online-preview-modal { background: rgba(15, 23, 42, 0.98); }

        /* Viewing Formats */
        .preview-title-block { column-span: all; width: 100%; margin-bottom: 2rem; }
        
        .view-columns {
            column-count: 2;
            column-gap: 3rem;
            column-rule: 1px solid #e2e8f0;
        }
        
        .view-table {
            display: block;
            width: 100%;
        }
        .view-table .content-para {
            display: block;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            background: #fff;
            margin-bottom: 0.5rem;
            border-left: 4px solid #6366f1;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        img.inserted-image {
            width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin: 2rem 0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-white text-slate-900 min-h-screen flex flex-col">

    <!-- Workspace Header -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-8 py-4 flex items-center justify-between">
      <button onclick="goBack()" 
    class="px-3 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-indigo-600 hover:bg-slate-100 transition">
    ‚Üê Back
</button>

        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <div>
                <h2 class="text-xl font-bold text-slate-900 tracking-tight leading-none">Research Workspace</h2>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Copy creator v3.3</span>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div id="status-indicator" class="hidden md:flex items-center gap-2 px-4 py-2 text-sm font-semibold text-slate-400">
                <div class="w-2 h-2 rounded-full bg-slate-200"></div>
                Ready
            </div>
            <div class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 border border-slate-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                </svg>
            </div>
        </div>
    </nav>
    
    <!-- Main Content Area -->
    <main class="flex-grow w-full max-w-7xl mx-auto py-10 px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            
            <!-- Left Column: Primary Inputs -->
            <div class="lg:col-span-7 space-y-10">
                <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-indigo-500 uppercase tracking-[0.2em] mb-4">Project Identity</label>
                        <input type="text" id="research-title"
                            placeholder="Enter the title of your research..." 
                            class="w-full text-4xl font-black bg-transparent border-b-2 border-slate-100 focus:border-indigo-500 focus:outline-none transition-all py-3 placeholder:text-slate-200 tracking-tight">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-indigo-500 uppercase tracking-[0.2em] mb-4">Target Length</label>
                        <select id="report-length" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:outline-none font-bold text-slate-700">
                            <option value="3 pages">3 Pages (600-750 words)</option>
                            <option value="4 pages">4 Pages (800-1000 words)</option>
                            <option value="5 pages">5 Pages (1000-1250 words)</option>
                            <option value="6 pages">6 Pages (1200-1500 words)</option>
                            <option value="7 pages">7 Pages (1400-1750 words)</option>
                            <option value="8 pages">8 Pages (1600-2000 words)</option>
                            <option value="9 pages">9 Pages (1800-2250 words)</option>
                            <option value="10 pages">10 Pages (2000-2500 words)</option>
                        </select>
                    </div>
                </section>

                <section>
                    <div class="flex items-center justify-between mb-4">
                        <label class="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-widest">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            AI Generated Extract
                        </label>
                        <div id="ai-badge" class="flex items-center gap-2 px-2 py-1 bg-slate-50 rounded-md transition-all">
                            <span id="badge-dot" class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                            <span id="badge-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Standby</span>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="ai-output" rows="14" 
                            placeholder="Your generated research copy will appear here..." 
                            class="w-full p-8 bg-slate-50/50 border border-slate-200 rounded-[2.5rem] shadow-sm focus:ring-8 focus:ring-indigo-500/5 focus:border-indigo-500 focus:bg-white focus:outline-none transition-all resize-none leading-relaxed text-slate-700 text-lg"></textarea>
                    </div>
                </section>

                <section id="export-suite" class="hidden animate-in fade-in slide-in-from-top-4 duration-500">
                    <div class="bg-indigo-50/50 rounded-[2rem] p-8 border border-indigo-100">
                        <h3 class="text-sm font-bold text-indigo-600 uppercase tracking-[0.2em] mb-6">Finest Research Export</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button onclick="downloadAsDoc()" class="flex items-center justify-center gap-3 py-4 bg-white hover:bg-slate-50 border border-indigo-200 rounded-2xl font-bold text-slate-700 transition-all shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414A1 1 0 0112.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg>
                                Download as Doc
                            </button>
                            <button onclick="exportOnline()" class="flex items-center justify-center gap-3 py-4 bg-white hover:bg-slate-50 border border-indigo-200 rounded-2xl font-bold text-slate-700 transition-all shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                                </svg>
                                Watch Online Preview
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Assets & Uploads -->
            <div class="lg:col-span-5 space-y-8">
                <section class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-xl">
                    <h3 class="text-xs font-bold text-indigo-200 uppercase tracking-widest mb-4">Security & AI Settings</h3>
                    <input type="password" id="api-key" placeholder="Enter Gemini API Key..." onchange="saveApiKey(this.value)" class="w-full bg-indigo-500/30 border border-indigo-400/30 rounded-2xl py-3 px-4 text-sm placeholder:text-indigo-300/60 focus:outline-none transition-all">
                </section>

                <section class="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-800 uppercase tracking-widest mb-6">Asset Manager</h3>
                    <div class="space-y-5">
                        <div class="upload-zone relative p-8 bg-white border-2 border-dashed border-slate-200 rounded-3xl transition-all cursor-pointer group shadow-sm">
                            <input type="file" id="doc-upload" accept=".pdf,.docx,.txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <div class="flex flex-col items-center text-center">
                                <div id="doc-icon" class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mb-4 transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414A1 1 0 0112.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                                </div>
                                <p id="doc-status" class="text-sm font-bold text-slate-800">Upload research file</p>
                            </div>
                        </div>

                        <div class="upload-zone relative p-8 bg-white border-2 border-dashed border-slate-200 rounded-3xl transition-all cursor-pointer group shadow-sm">
                            <input type="file" id="image-upload" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <div class="flex flex-col items-center text-center">
                                <div id="img-icon" class="w-14 h-14 bg-rose-50 text-rose-500 rounded-2xl flex items-center justify-center mb-4 transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                </div>
                                <p id="img-status" class="text-sm font-bold text-slate-800">Upload photos</p>
                            </div>
                        </div>
                    </div>
                </section>

                <button onclick="generateResearch()" id="generate-btn" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold text-sm hover:bg-indigo-600 transition-all flex items-center justify-center gap-3 disabled:opacity-50">
                    <span>Process & Generate</span>
                </button>
            </div>
        </div>
    </main>

    <!-- ONLINE PREVIEW MODAL -->
    <div id="online-preview-modal" class="hidden fixed inset-0 z-[100] flex flex-col p-4 md:p-12 overflow-hidden">
        <div class="max-w-6xl mx-auto w-full bg-white h-full rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <h3 class="font-bold text-slate-900 text-xs uppercase tracking-widest">Interactive Viewer</h3>
                    <div class="flex bg-slate-100 p-1 rounded-xl gap-1">
                        <button onclick="changeView('page')" id="btn-page" class="view-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow-sm text-indigo-600">Page</button>
                        <button onclick="changeView('table')" id="btn-table" class="view-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500 hover:bg-white/50">Table</button>
                        <button onclick="changeView('columns')" id="btn-columns" class="view-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500 hover:bg-white/50">Columns</button>
                    </div>
                </div>
                <button onclick="closeOnlinePreview()" class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-8 md:p-16 document-font custom-scrollbar bg-slate-50/30">
                <div id="preview-wrapper" class="max-w-4xl mx-auto bg-white p-12 md:p-20 shadow-sm border border-slate-100 min-h-full">
                    <div class="preview-title-block">
                        <h1 id="preview-title" class="text-5xl font-black text-slate-900 leading-tight"></h1>
                    </div>
                    <div id="preview-content" class="text-slate-800 leading-relaxed text-lg whitespace-pre-wrap transition-all duration-300"></div>
                </div>
            </div>
            <div class="px-8 py-6 bg-slate-50 border-t flex items-center justify-between">
                <p class="text-[10px] font-bold text-slate-400">RESEARCH OUTPUT v3.3</p>
                <div class="flex gap-3">
                    <button id="humanize-btn" onclick="humanizeResearch()" class="px-6 py-2 bg-indigo-50 text-indigo-600 border border-indigo-200 rounded-xl text-xs font-bold hover:bg-indigo-600 hover:text-white transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Humanize Paper
                    </button>
                    <button onclick="downloadAsDoc()" class="px-6 py-2 bg-slate-900 text-white rounded-xl text-xs font-bold hover:bg-indigo-600 transition-all">Download Doc</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full shadow-2xl">
            <p id="error-message" class="text-slate-500 text-sm mb-6"></p>
            <button onclick="closeError()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-sm">Dismiss</button>
        </div>
    </div>

    <script>
        let extractedText = "";
        let imageDataUrls = []; 

        window.onload = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) document.getElementById('api-key').value = savedKey;
        };

        function saveApiKey(val) { localStorage.setItem('gemini_api_key', val); }

        document.getElementById('doc-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                extractedText = event.target.result;
                document.getElementById('doc-status').innerText = file.name;
                document.getElementById('doc-icon').className = "w-14 h-14 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center mb-4";
            };
            reader.readAsText(file);
        });

        document.getElementById('image-upload').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            
            imageDataUrls = [];
            document.getElementById('img-status').innerText = "Processing photos...";
            
            for (const file of files) {
                const dataUrl = await fileToDataUrl(file);
                imageDataUrls.push(dataUrl);
            }
            document.getElementById('img-status').innerText = `${files.length} Photos Prepared`;
            document.getElementById('img-icon').className = "w-14 h-14 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center mb-4";
        });

        function fileToDataUrl(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
            });
        }

        function getSanitizedHtml(rawText) {
            let cleanText = rawText
                .replace(/^#+\s/gm, '')         
                .replace(/\*\*(.*?)\*\*/g, '$1') 
                .replace(/\*(.*?)\*/g, '$1')     
                .replace(/---|___/g, '')         
                .replace(/`{1,3}.*?`{1,3}/gs, '')
                .trim();

            return cleanText.split('\n').map(para => {
                if (!para.trim()) return '';
                const imgRegex = /{{IMAGE:(\d+)}}/;
                if (imgRegex.test(para)) {
                    return para.replace(imgRegex, (match, index) => {
                        const idx = parseInt(index);
                        if (imageDataUrls[idx]) {
                            return `<img src="${imageDataUrls[idx]}" class="inserted-image" style="width:100%; max-width:600px; display:block; margin:20px auto; border-radius:10px;" alt="Asset ${idx}">`;
                        }
                        return '';
                    });
                }
                return `<p style="margin-bottom:15px; line-height:1.6;">${para}</p>`;
            }).join('');
        }

        function renderContent(rawText, targetElement) {
            const currentView = targetElement.dataset.view || 'page';
            let html = getSanitizedHtml(rawText);
            
            if (currentView === 'table') {
                html = html.replace(/<p(.*?)>(.*?)<\/p>/g, '<div class="content-para">$2</div>');
            }
            targetElement.innerHTML = html;
        }

        async function generateResearch() {
            const apiKey = document.getElementById('api-key').value;
            const title = document.getElementById('research-title').value;
            const length = document.getElementById('report-length').value;
            const outputArea = document.getElementById('ai-output');

            if (!apiKey) return showError("Enter your API key.");
            if (!extractedText) return showError("Upload research file.");

            setLoading(true);

            const wordCountMap = {
                "3 pages": "600-750 words", "4 pages": "800-1000 words", "5 pages": "1000-1250 words",
                "6 pages": "1200-1500 words", "7 pages": "1400-1750 words", "8 pages": "1600-2000 words",
                "9 pages": "1800-2250 words", "10 pages": "2000-2500 words"
            };

            const targetWords = wordCountMap[length];

            const sysPrompt = `You are an elite Research Analyst. 
            TITLE: ${title || "Untitled Research"}
            TARGET LENGTH: ${length} (${targetWords}).
            
            TASK: 
            1. Rewrite data into a professional report.
            2. USE UPLOADED IMAGES: You MUST place image placeholders {{IMAGE:N}} where relevant.
            3. OUTPUT: Pure text, no markdown characters like # or *.
            4. COMPLIANCE: Write precisely ${targetWords}.`;

            const contents = [{ 
                parts: [
                    { text: `DATA:\n${extractedText}` },
                    ...imageDataUrls.map((url, i) => ({
                        inlineData: { mimeType: "image/png", data: url.split(',')[1] }
                    }))
                ] 
            }];

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: sysPrompt }] } })
                });

                const data = await response.json();
                outputArea.value = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                setLoading(false, "success");
                document.getElementById('export-suite').classList.remove('hidden');
            } catch (err) {
                showError("API Error. Check key.");
                setLoading(false, "error");
            }
        }

        async function humanizeResearch() {
            const apiKey = document.getElementById('api-key').value;
            const currentContent = document.getElementById('ai-output').value;
            const hBtn = document.getElementById('humanize-btn');
            const previewContent = document.getElementById('preview-content');

            if (!apiKey || !currentContent) return;

            hBtn.disabled = true;
            hBtn.innerHTML = `<svg class="animate-spin h-3.5 w-3.5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Humanizing...`;

            const sysPrompt = `You are an expert academic editor. Rewrite the following research paper to sound completely natural, human-written, and professional. 
            CRITICAL RULES:
            1. Remove all robotic phrasing, repetitive sentence structures, and typical AI-isms.
            2. Maintain the exact same section headings and factual data.
            3. KEEP the image placeholders like {{IMAGE:N}} exactly where they are.
            4. Optimize for IEEE, Google Scholar, and academic publication standards.
            5. Output PURE text without markdown symbols (#, *).`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: currentContent }] }], 
                        systemInstruction: { parts: [{ text: sysPrompt }] } 
                    })
                });

                const data = await response.json();
                const result = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                
                // Update both background store and active preview
                document.getElementById('ai-output').value = result;
                renderContent(result, previewContent);

                hBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Humanized!`;
                setTimeout(() => {
                    hBtn.disabled = false;
                    hBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Humanize Paper`;
                }, 2000);

            } catch (err) {
                showError("Humanization failed. Check connection.");
                hBtn.disabled = false;
                hBtn.innerText = "Humanize Paper";
            }
        }

        function downloadAsDoc() {
            const title = document.getElementById('research-title').value || "Research-Report";
            const contentHtml = getSanitizedHtml(document.getElementById('ai-output').value);
            
            const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                            <head><meta charset='utf-8'><title>${title}</title>
                            <style>body {font-family: 'Merriweather', serif; padding: 40px;} h1 {text-align: center;} img {display:block; margin:auto;}</style>
                            </head><body>`;
            const footer = "</body></html>";
            
            const fullHtml = header + `<h1>${title}</h1>` + contentHtml + footer;
            
            const blob = new Blob(['\ufeff', fullHtml], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${title}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function changeView(format) {
            const wrapper = document.getElementById('preview-wrapper');
            const contentArea = document.getElementById('preview-content');
            const btns = document.querySelectorAll('.view-btn');
            btns.forEach(b => { b.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600'); b.classList.add('text-slate-500'); });
            document.getElementById(`btn-${format}`).classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            wrapper.classList.remove('view-columns', 'view-table');
            if (format === 'columns') wrapper.classList.add('view-columns');
            if (format === 'table') wrapper.classList.add('view-table');
            contentArea.dataset.view = format;
            renderContent(document.getElementById('ai-output').value, contentArea);
        }

        function exportOnline() {
            document.getElementById('preview-title').innerText = document.getElementById('research-title').value || "Research Report";
            document.getElementById('online-preview-modal').classList.remove('hidden');
            changeView('page');
        }

        function closeOnlinePreview() { document.getElementById('online-preview-modal').classList.add('hidden'); }

        function setLoading(active, state = "") {
            const btn = document.getElementById('generate-btn');
            const dot = document.getElementById('badge-dot');
            const txt = document.getElementById('badge-text');
            if (active) {
                btn.disabled = true; btn.innerText = "Synthesizing Multimodal Report...";
                dot.className = "w-1.5 h-1.5 rounded-full bg-indigo-500 animate-pulse";
                txt.innerText = "Processing Assets...";
            } else {
                btn.disabled = false; btn.innerText = "Process & Generate";
                if (state === "success") { dot.className = "w-1.5 h-1.5 rounded-full bg-green-500"; txt.innerText = "Finest Copy Generated"; }
            }
        }

        function showError(m) { document.getElementById('error-message').innerText = m; document.getElementById('error-modal').classList.remove('hidden'); }
        function closeError() { document.getElementById('error-modal').classList.add('hidden'); }
    </script>
    <script>
function goBack() {
    window.location.href = "file:///D:/copy%20creater.html";
}
</script>

</body>
</html>